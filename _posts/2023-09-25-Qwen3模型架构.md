---
layout: distill
title: Qwen3模型架构
description: 这篇blog主要介绍目前主流GPT架构中使用到的一些模块。
giscus_comments: true
date: 2025-12-24
math: true

authors:
  - name: Yaowei Hu
    # url: "https://en.wikipedia.org/wiki/Albert_Einstein"
    affiliations:
      name: Walmart Inc.
  
bibliography:

# Optionally, you can add a table of contents to your post.
# NOTES:
#   - make sure that TOC names match the actual section names
#     for hyperlinks within the post to work correctly.
#   - we may want to automate TOC generation in the future using
#     jekyll-toc plugin (https://github.com/toshimaru/jekyll-toc).
toc:
  - name: 旋转位置编码（RoPE）
    # if a section has subsections, you can add them as follows:
    # subsections:
    #   - name: Example Child Subsection 1
    #   - name: Example Child Subsection 2
  - name: 
  - name: 
  
# Below is an example of injecting additional post-specific styles.
# If you use this post as a template, delete this _styles block.
_styles: >

---


## 旋转位置编码（RoPE）
绝对位置编码具有实现简单、计算速度快等优点，而相对位置编码则更合我们的直觉吻合，实际性能往往也更好。而RoPE则集各家之长，实现了“以绝对位置编码的方式实现相对位置编码”。

RoPE希望的建模目标为：找到一个函数$f$，使得如下关系成立

$$f(q, m) \cdot f(k, n) = g(q, k, m - n)$$

其中，$f$是把位置信息结合到query/key embeddings的机制。$g$是以query/key embedidings和相对位置$m - n$为输入的函数。该函数的左边是以绝对位置编码，而右边是实现了相对位置编码。

RoPE得到的最终函数$f$为

$$f(q, m) = R_mq = \begin{pmatrix} \cos m\theta & -\sin m\theta \\ \sin m\theta & \cos m\theta \end{pmatrix} \begin{pmatrix} p_0 \\ p_1 \end{pmatrix}$$

左侧的$R_m$是一个旋转矩阵，$f(q, m)$表示在保持向量$q$的模长的同时，将其逆时针旋转$m\theta$。这意味着只需要装将向量旋转某个角度，即可实现对该向量添加绝对位置信息，这就是旋转位置编码的由来。

进一步验证RoPE以绝对位置编码实现相对位置编码

$$\begin{align} 
q_m \cdot k_n &= f(q, m) \cdot f(k, n) \\
&= (R_mq)^T * (R_nk) \\
&= q^TR_m^T * R_nk \\
&=q^T\begin{bmatrix} cos(n-m)\theta & -sin(n-m)\theta \\ sin(n-m)\theta & cos(n-m)\theta \end{bmatrix} k \\
&=q^TR_{n-m}k
\end{align}$$

## 参考
[Transformer升级之路：2、博采众长的旋转式位置编码](https://kexue.fm/archives/8265)    
[图解RoPE旋转位置编码及其特性](https://zhuanlan.zhihu.com/p/667864459)